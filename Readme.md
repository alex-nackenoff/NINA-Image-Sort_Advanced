# NINA Advanced Image Sorting Script (v2)

## Advanced/ v2 Features
<b>Requirements:</b> Designed to work with the NINA Session Metadata plugin (specifically the csv file output), with default settings. This script parses the ImageMetaData.csv file and identifies subpar images based on poor guiding (eg. wind), focus, or star count (eg. clouds or buildings in my case). I designed this version of the script for more advanced sorting options that don't require adding the stats to the file name (as long file names can cause issues in Pixinsight) 

>If you would prefer sorting images based on NINA image naming convention w/ stats, see v1 of the sorting script [here](https://github.com/alex-nackenoff/NINA-Image-Sort)

<b>Optional:</b> Compatible with Robocopy and Discord Alert plugins

## Description:
Instead of manually sorting through astrophotography images generated by NINA, I made this script to automatically sort out images that are unusuable for stacking due to wind, major cloud cover, guiding issues, etc. The python script finds the most recent project folder, analyzes the session metadata csv file and sorts out subpar images based on star count, HFR, and guiding stats, but without deleting the files in case the script is overly aggressive. This script is called by the .bat file at the end of a NINA Advanced Sequence. The sorting thresholds are arbitrary, so obviously you should tailor to fit your needs. 

## Requirements/Python Install:
1. Install [miniconda](https://docs.conda.io/projects/miniconda/en/latest/index.html). This will install python and some necessary components. This saves a bit of space over a full anaconda install, but if you already have anaconda installed you can use that.
2. The .bat file is designed to work with miniconda added to PATH, so during the install procedure do check the box to install to PATH. You can always add the folder to PATH if you skipped this step
3. Once install is finished, it's a good idea to ensure conda is happy and working. Open a command prompt window and update conda

```
conda update conda
```

enter y as needed

4. Then, it's best practice to run each python project in its own virtual environment.

```
conda create --name nina
```

again enter y as needed

5. Then lets activate the new virtual environment to ensure things are working

```
conda activate nina
```

if everything is working, you should see something like:

```
(nina) C:\Users\<user>
```

Next, install the requirements (pandas [to parse the csv], and discordwebhook [for discord alerts])
```python
pip install -r requirements.txt
```

## Optional Discord Alert
I included a Discord alert, mostly since I like to wake up and see on my phone that my mount is in the home position (using the Discord alert NINA plugin), and figured that I would also like to see how many frames got thrown out, and for what target (since I shoot multiple targets in a night). If you don't want this integration, comment out (#) the discord related commands.

and insert your Discord bot webhook url where noted in the python code

type exit to close

6. Download and extract the zip folder of this repo, and place the .bat and .py file in your default NINA save location. For me that's "D:\NINA_Local_Ingest\"


## .bat File Editing
The .bat file is designed to run at the end of your NINA advanced sequence, but needs to be customized to work in your setup. NINA will run the .bat file from wherever you have it stored, but will try to run it from its program folder. So the .bat file needs to be edited to hard code to change directories to where NINA saves your images by default

```
@echo off
title Sort NINA images

cmd /k "cd /d <folder location here without brackets> && conda activate nina && python NINA_sort_Advanced_for_HFR_RMS_Stars.py && exit"
```

### Example .bat
```
@echo off
title Sort NINA images 

cmd /k "cd /d D:\NINA_Local_Ingest && conda activate nina && python NINA_sort_Advanced_for_HFR_RMS_Stars.py && exit"
```

Once that's ready, add 'External Script' as a new step in your NINA advanced sequence, and point it to your .bat file

## Python Script Behavior

### Assumptions
NINA File Structure: 

\$$DATEMINUS12\$$\\$$TARGETNAME\$$\\$$IMAGETYPE\$$\\

+ Inside the LIGHTS folder should have ImageMetaData.csv together with .fits files


Below is the key section of the python script that sorts images. Thresholds should be individually tailored to your setup. Some make sense to be hardcoded (ie. guiding, where the cap is your imaging scale on an arcseconds per pixel basis; for me that's 2.2), but the others it may make sense a sigma clipping (x Standard Deviations away from the mean) or distance from median methodology. 

```python
# HFR Cutoff
            mean_hfr=df1['HFR'].mean()
            median_hfr=df1['HFR'].median()
            stdev_hfr=df1['HFR'].std()
            hfr_cutoff=median_hfr*(1.15) # 15% above median HFR cutoff, arbitrary, modify for your needs 
            hfr_cut=df1.loc[((df1['HFR']>hfr_cutoff) | (df1['HFR']<0.1), 'HFR')] # reject if above HFR cutoff OR HFR = 0 (no stars)
            sorted_4_hfr=len(hfr_cut) # counter for reporting

            # Star Cutoff
            star_cutoff=df1['DetectedStars'].median()*(0.5) # 50% below median star cutoff, arbitrary
            star_cut=df1.loc[((df1['DetectedStars']<star_cutoff, 'DetectedStars'))]
            sorted_4_stars=len(star_cut)

            # Guiding Cutoff
            guiding_cutoff=2.2 # maximum pixel scale in arcseconds per pixel, modify for your needs
            guide_cut=df1.loc[((df1['GuidingRMSArcSec']>guiding_cutoff, 'GuidingRMSArcSec'))]
            sorted_4_guiding=len(guide_cut)


```

## Example Discord Alert Output

Inside the analysis loop, reports analyzed target (ie the current parent folder), reports total number of rejected frames, and total usable imaging time (assumes all subframes shot at same exposure length). Only includes details if any trigger was satisfied.

```
Analyzing hamburger......
    Moved 0 (0%) total files
   Total Usable Images: 2.50h
Analyzing NGC 4565......
    Moved 2 (4%) total files
   Total Usable Images: 3.67h
Analyzing Spider Nebula......
    Moved 5 (17%) total files
   Total Usable Images: 2.00h
    Moved 5 files due to stars
```